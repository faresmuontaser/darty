"""
AI Tutor Module
Integrates with Google Gemini API to provide expert tutoring in Arabic for absolute beginners
"""

import google.generativeai as genai
from typing import Optional, List, Dict
import json


class DartFlutterTutor:
    """AI-powered Dart & Flutter expert tutor using Google Gemini"""
    
    SYSTEM_PROMPT = """ุฃูุช ูุนูู ุฎุจูุฑ ูู ูุบุฉ Dart ูุฅุทุงุฑ ุนูู Flutterุ ูุชุฎุตุต ูู ุชุนููู ุงููุจุชุฏุฆูู ุชูุงูุงู (ุงูุฐูู ูู ูุณุจู ููู ุฏุฑุงุณุฉ ุงูุจุฑูุฌุฉ).

## ูููุชู:

1. **ุงูุดุฑุญ ูููุจุชุฏุฆูู**: ุงุณุชุฎุฏู ูุบุฉ ุนุฑุจูุฉ ุจุณูุทุฉ ุฌุฏุงูุ ูุงุดุฑุญ ูู ููููู ุจุฑูุฌู ูุฃูู ุชุดุฑุญู ูุดุฎุต ูุง ูุนุฑู ุดูุฆุงู ุนู ุงูุจุฑูุฌุฉ
2. **ุงูุชุทุจูู ุงูุนููู**: ุงุฑุจุท ูู ุฏุฑุณ ุจูุดุฑูุน ุญูููู (ุชุทุจูู ููุจุงูู ุฃู ูููุน)ุ ูุงุดุฑุญ ููู ููุณุชุฎุฏู ุงูููููู ูู ุจูุงุก ุชุทุจููุงุช ุญููููุฉ
3. **ุฃูุซูุฉ ูุงูุนูุฉ**: ูุฏู ุฃูุซูุฉ ูู ุชุทุจููุงุช ูุนุฑููุฉ (ูุซู: ูุงุชุณุงุจุ ุฅูุณุชุบุฑุงูุ ูุชุฌุฑ ุฅููุชุฑููู)
4. **ุงูุชุฏุฑูุจ ุงูุนููู**: ุจุนุฏ ูู ุดุฑุญุ ุฃูุดุฆ 3 ุชูุงุฑูู ุนูููุฉ ุชุชุฏุฑุฌ ูู ุงูุณูู ูููุชูุณุท
5. **ุงูุชุดุฌูุน**: ุงุณุชุฎุฏู ุฃุณููุจ ูุญูุฒ ููุดุฌุน ูููุชุนูู

## ููุงุนุฏ ูููุฉ:

- ุงุณุชุฎุฏู ุงููุบุฉ ุงูุนุฑุจูุฉ ุงููุตุญู ุงููุจุณุทุฉ ููุท
- ุงูุชุจ ุงูููุฏ ุจูุบุฉ Dart ูุน ุชุนูููุงุช ุจุงูุนุฑุจูุฉ
- ุงุจุฏุฃ ูู ุดุฑุญ ุจูุซุงู ูู ุงูุญูุงุฉ ุงููุงูุนูุฉ
- ุงุดุฑุญ "ููุงุฐุง" ู"ูุชู" ูุณุชุฎุฏู ูู ููููู
- ูุณูู ุงูููุงููู ุงููุนูุฏุฉ ุฅูู ุฎุทูุงุช ุตุบูุฑุฉ
- ุงุณุชุฎุฏู ุงูุชุดุจููุงุช ูู ุงูุญูุงุฉ ุงูููููุฉ
- ุจุนุฏ ูู ุดุฑุญุ ุงุทุฑุญ ุณุคุงู "ูู ูููุชุ" ูุงุดุฑุญ ุจุทุฑููุฉ ุฃุฎุฑู ุฅุฐุง ูุฒู ุงูุฃูุฑ

## ุงูุจููุฉ ุงูุชุนููููุฉ:

ุนูุฏ ุดุฑุญ ุฃู ูููููุ ุงุชุจุน ูุฐู ุงูุจููุฉ:

1. **ุงูุชุดุจูู**: ุงุดุฑุญ ุงูููููู ุจูุซุงู ูู ุงูุญูุงุฉ ุงูููููุฉ
2. **ุงูุชุนุฑูู**: ุนุฑูู ุงูููููู ุจูุบุฉ ุจุณูุทุฉ
3. **ุงููุงุฆุฏุฉ**: ุงุดุฑุญ ููุงุฐุง ูุญุชุงุฌ ูุฐุง ุงูููููู
4. **ุงููุซุงู ุงูุนููู**: ูุฏู ููุฏ ุจุณูุท ูุน ุดุฑุญ ูู ุณุทุฑ
5. **ุงูุชุทุจูู ุงููุงูุนู**: ุงุดุฑุญ ููู ููุณุชุฎุฏู ูู ุชุทุจูู ุญูููู
6. **ุงูุชูุงุฑูู**: 3 ุชูุงุฑูู ุนูููุฉ (ุณููุ ูุชูุณุทุ ุชุญุฏู)
7. **ุงููุตูุญุฉ**: ูุตูุญุฉ ุฃู ููุงุญุธุฉ ูููุฉ

## ูุซุงู ุนูู ุงูุฃุณููุจ:

โ ุณูุก: "ุงููุชุบูุฑ ูู ููุงู ูุชุฎุฒูู ุงูุจูุงูุงุช"
โ ุฌูุฏ: "ุชุฎูู ุงููุชุบูุฑ ูุฃูู ุตูุฏูู ูู ุงุณูุ ูุถุน ููู ุฃุดูุงุก ููุณุชุฎุฏููุง ูุงุญูุงู. ูุซูุงูุ ูู ุชุทุจูู ูุงุชุณุงุจุ ุงุณูู ูุฎุฒู ูู ูุชุบูุฑุ ูุฑูู ูุงุชูู ูู ูุชุบูุฑ ุขุฎุฑ"

ุชุฐูุฑ: ูุฏูู ุชุญููู ุงููุจุชุฏุฆ ุงููุงูู ุฅูู ูุทูุฑ ูุงุฏุฑ ุนูู ุจูุงุก ุชุทุจููุงุช ุญููููุฉ!
"""
    
    def __init__(self, api_key: str, documentation_context: Optional[str] = None):
        """
        Initialize the AI tutor
        
        Args:
            api_key: Google API key
            documentation_context: Optional context from scraped documentation
        """
        genai.configure(api_key=AIzaSyAUZ7VaH2WpDv_PS_Wmi0hH_C4u8Dajbr8)
        
        # Use Gemini 3 Flash model
        self.model = genai.GenerativeModel(
            model_name='gemini-2.0-flash-exp',
            generation_config={
                'temperature': 0.7,
                'top_p': 0.95,
                'top_k': 40,
                'max_output_tokens': 8192,
            }
        )
        
        self.documentation_context = documentation_context or ""
        self.chat_session = None
        self._initialize_chat()
    
    def _initialize_chat(self):
        """Initialize chat session with system prompt"""
        # Build initial context
        context_parts = [self.SYSTEM_PROMPT]
        
        if self.documentation_context:
            context_parts.append(f"""
            
## ุงูุณูุงู ูู ุงููุซุงุฆู ุงูุฑุณููุฉ:

{self.documentation_context[:4000]}

ุงุณุชุฎุฏู ูุฐู ุงููุนูููุงุช ูุถูุงู ุฏูุฉ ุฅุฌุงุจุงุชู ูุงูุฅุดุงุฑุฉ ูุฃุญุฏุซ ุงูุฅุตุฏุงุฑุงุช ูุงูููุฒุงุช.
""")
        
        # Start chat session
        self.chat_session = self.model.start_chat(history=[])
        
        # Send system prompt as first message
        try:
            self.chat_session.send_message("\n".join(context_parts))
        except Exception as e:
            print(f"Error initializing chat: {e}")
    
    def ask(self, question: str, include_context: bool = True) -> Optional[str]:
        """
        Ask the tutor a question
        
        Args:
            question: The question to ask
            include_context: Whether to include documentation context
            
        Returns:
            The tutor's response or None if failed
        """
        try:
            if not self.chat_session:
                self._initialize_chat()
            
            # Send message and get response
            response = self.chat_session.send_message(question)
            return response.text
        
        except Exception as e:
            print(f"Error calling Gemini API: {e}")
            return f"ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุณุคุงูู: {str(e)}"
    
    def analyze_code(self, code: str) -> Optional[str]:
        """
        Analyze Dart/Flutter code and provide feedback
        
        Args:
            code: The code to analyze
            
        Returns:
            Analysis and suggestions for beginners
        """
        prompt = f"""ูู ุจุชุญููู ุงูููุฏ ุงูุชุงูู ุจุฃุณููุจ ููุงุณุจ ุงููุจุชุฏุฆูู:

```dart
{code}
```

ูุฏู:
1. **ูุงุฐุง ููุนู ูุฐุง ุงูููุฏุ** - ุงุดุฑุญ ุจูุบุฉ ุจุณูุทุฉ ุฌุฏุงู
2. **ุดุฑุญ ูู ุณุทุฑ** - ุงุดุฑุญ ูู ุณุทุฑ ุจุงูุชูุตูู
3. **ูุง ุงูุฌูุฏ ูู ูุฐุง ุงูููุฏุ** - ููุงุท ุงูููุฉ
4. **ููู ูุญุณูููุ** - ุงูุชุฑุงุญุงุช ููุชุญุณูู ูุน ุดุฑุญ ุงูุณุจุจ
5. **ุชุทุจูู ุญูููู** - ุฃูู ูููู ุงุณุชุฎุฏุงู ูุฐุง ุงูููุฏ ูู ุชุทุจูู ูุงูุนูุ
6. **ุชุญุฐูุฑุงุช** - ุฃู ุฃุฎุทุงุก ูุญุชููุฉ ูุฌุจ ุชุฌูุจูุง

ุงุณุชุฎุฏู ุฃุณููุจ ุชุนูููู ูุดุฌุน!"""
        
        return self.ask(prompt, include_context=False)
    
    def generate_exercises(self, topic: str) -> Optional[str]:
        """
        Generate practice exercises for a topic
        
        Args:
            topic: The topic to generate exercises for
            
        Returns:
            Generated exercises suitable for beginners
        """
        prompt = f"""ุฃูุดุฆ 3 ุชูุงุฑูู ุนูููุฉ ุญูู ููุถูุน: **{topic}**

ููู ุชูุฑูู:

**๐ ุงูุชูุฑูู ุงูุฃูู (ุณูู):**
- ุงููุฏู: ูุงุฐุง ุณูุชุนูู ุงููุชุฏุฑุจุ
- ุงููุทููุจ: ูุตู ูุงุถุญ ูููุทููุจ
- ูุซุงู ุนูู ุงููุฏุฎูุงุช
- ุงููุฎุฑุฌุงุช ุงููุชููุนุฉ
- ุชูููุญ: ูุณุงุนุฏุฉ ุจุณูุทุฉ

**๐ ุงูุชูุฑูู ุงูุซุงูู (ูุชูุณุท):**
[ููุณ ุงูุจููุฉ]

**๐ ุงูุชูุฑูู ุงูุซุงูุซ (ุชุญุฏู):**
[ููุณ ุงูุจููุฉ]

**๐ก ูุตูุญุฉ ุนุงูุฉ:** ูุตูุญุฉ ุชุณุงุนุฏ ูู ุญู ุงูุชูุงุฑูู

ุงุฌุนู ุงูุชูุงุฑูู ูุฑุชุจุทุฉ ุจูุดุงุฑูุน ุญููููุฉ (ูุซู: ุจูุงุก ุขูุฉ ุญุงุณุจุฉุ ูุงุฆูุฉ ููุงูุ ูููุฐุฌ ุชุณุฌูู ุฏุฎูู)"""
        
        return self.ask(prompt, include_context=True)
    
    def explain_concept(self, concept: str) -> Optional[str]:
        """
        Explain a Dart/Flutter concept in detail for absolute beginners
        
        Args:
            concept: The concept to explain
            
        Returns:
            Detailed beginner-friendly explanation
        """
        prompt = f"""ุงุดุฑุญ ููููู **{concept}** ูู Dart/Flutter ุจุฃุณููุจ ููุงุณุจ ุงููุจุชุฏุฆ ุงููุงูู:

## ๐ ุงูุจููุฉ ุงููุทููุจุฉ:

### 1๏ธโฃ ุงูุชุดุจูู ูู ุงูุญูุงุฉ
ุงุดุฑุญ ุงูููููู ุจูุซุงู ูู ุงูุญูุงุฉ ุงูููููุฉ ููููู ุงูุฌููุน

### 2๏ธโฃ ุงูุชุนุฑูู ุงูุจุณูุท
ูุง ูู {concept}ุ (ุจูุบุฉ ุจุณูุทุฉ ุฌุฏุงู)

### 3๏ธโฃ ููุงุฐุง ูุญุชุงุฌูุ
ูุง ุงููุงุฆุฏุฉ ูู ุงุณุชุฎุฏุงู {concept}ุ

### 4๏ธโฃ ูุซุงู ุนููู ุจุณูุท
ูุฏู ููุฏ ุจุณูุท ุฌุฏุงู ูุน ุดุฑุญ ูู ุณุทุฑ ุจุงูุชูุตูู

### 5๏ธโฃ ุชุทุจูู ูุงูุนู
ููู ููุณุชุฎุฏู ูู ุชุทุจูู ุญููููุ (ูุซู: ุชุทุจูู ุชูุตูู ุทุนุงูุ ุชุทุจูู ุชูุงุตู ุงุฌุชูุงุนู)

### 6๏ธโฃ ุฃุฎุทุงุก ุดุงุฆุนุฉ
ูุง ุงูุฃุฎุทุงุก ุงูุชู ููุน ูููุง ุงููุจุชุฏุฆูู ุนูุฏ ุงุณุชุฎุฏุงู {concept}ุ

### 7๏ธโฃ ูุตูุญุฉ ุฐูุจูุฉ
ูุตูุญุฉ ูููุฉ ูููุจุชุฏุฆูู

---

**ุซู ุฃูุดุฆ 3 ุชูุงุฑูู ุนูููุฉ ุตุบูุฑุฉ ููุชุทุจูู ุงููุจุงุดุฑ**

ุงุณุชุฎุฏู ุงูุฑููุฒ ุงูุชุนุจูุฑูุฉ (emojis) ูุฌุนู ุงูุดุฑุญ ุฃูุซุฑ ูุชุนุฉ! ๐ฏ"""
        
        return self.ask(prompt, include_context=True)
    
    def review_student_answer(self, exercise: str, student_answer: str) -> Optional[str]:
        """
        Review a student's answer to an exercise
        
        Args:
            exercise: The original exercise
            student_answer: Student's solution
            
        Returns:
            Detailed review and feedback
        """
        prompt = f"""ูู ุจูุฑุงุฌุนุฉ ุฅุฌุงุจุฉ ุงููุชุฏุฑุจ ุจุฃุณููุจ ูุดุฌุน ูุชุนูููู:

**ุงูุชูุฑูู ุงูุฃุตูู:**
{exercise}

**ุฅุฌุงุจุฉ ุงููุชุฏุฑุจ:**
```dart
{student_answer}
```

---

## ๐ ุงููุฑุงุฌุนุฉ:

### โ ูุง ูู ุตุญูุญุ
ุงุฐูุฑ ูู ูุง ูุนูู ุงููุชุฏุฑุจ ุจุดูู ุตุญูุญ (ูู ูุดุฌุนุงู!)

### ๐ก ูุง ูููู ุชุญุณูููุ
ุงูุชุฑุงุญุงุช ููุชุญุณูู ูุน ุดุฑุญ ุงูุณุจุจ

### ๐ ุชุญููู ุงูููุฏ:
ุฑุงุฌุน ุงูููุฏ ุณุทุฑ ุจุณุทุฑ ุฅุฐุง ูุฒู ุงูุฃูุฑ

### โจ ุงูุญู ุงูุฃูุซู:
ูุฏู ุงููุณุฎุฉ ุงููุญุณููุฉ ูู ุงูููุฏ ูุน ุงูุดุฑุญ

### ๐ฏ ุฎุทูุฉ ุชุงููุฉ:
ุงูุชุฑุญ ุชูุฑูู ุฅุถุงูู ุฃู ููููู ุฌุฏูุฏ ููุชุนูู

ุงุณุชุฎุฏู ุฃุณููุจ ุฅูุฌุงุจู ููุญูุฒ! ๐"""
        
        return self.ask(prompt, include_context=False)
    
    def create_real_world_project(self, level: str = "beginner") -> Optional[str]:
        """
        Create a real-world project idea suitable for the student's level
        
        Args:
            level: Student level (beginner, intermediate, advanced)
            
        Returns:
            Complete project guide
        """
        prompt = f"""ุฃูุดุฆ ููุฑุฉ ูุดุฑูุน ุญูููู ุจูุณุชูู **{level}** ูู Flutter:

## ๐ฏ ุงููุดุฑูุน

### ๐ฑ ุงูููุฑุฉ:
ูุง ูู ุงูุชุทุจูู/ุงููููุนุ (ููุฑุฉ ูุงูุนูุฉ ูููุฏุฉ)

### โจ ุงูููุฒุงุช ุงูุฃุณุงุณูุฉ:
3-5 ููุฒุงุช ุฑุฆูุณูุฉ

### ๐๏ธ ุงูููุงููู ุงููุทููุจุฉ:
ูุง ุงูููุงููู ุงูุจุฑูุฌูุฉ ุงูุชู ุณูุชุนูููุง ุงููุชุฏุฑุจุ

### ๐ ุงูุฏุฑูุณ ุงูุชุญุถูุฑูุฉ:
ูุง ุงูุฐู ูุฌุจ ุฃู ูุชุนููู ุงููุชุฏุฑุจ ูุจู ุงูุจุฏุกุ

### ๐บ๏ธ ุฎุทุฉ ุงูุชูููุฐ:
ูุณูู ุงููุดุฑูุน ุฅูู 5-7 ุฎุทูุงุช ูุงุถุญุฉ

### ๐ป ููุฏ ุงูุจุฏุงูุฉ:
ูุฏู ููุฏ ุฃููู ุจุณูุท ููุจุฏุก

### ๐จ ูุตุงุฆุญ ููุชุตููู:
ููู ูุฌุนู ุงูุชุทุจูู ุฌุฐุงุจุงูุ

### ๐ ุงูุชุทููุฑ ุงููุณุชูุจูู:
ุฃููุงุฑ ูุชุทููุฑ ุงููุดุฑูุน ูุงุญูุงู

ุงุฌุนู ุงููุดุฑูุน ููุชุนุงู ููููุฏุงู ูู ููุณ ุงูููุช! ๐"""
        
        return self.ask(prompt, include_context=True)
    
    def update_context(self, new_context: str) -> None:
        """
        Update the documentation context and reinitialize chat
        
        Args:
            new_context: New documentation context
        """
        self.documentation_context = new_context
        self._initialize_chat()
    
    def clear_history(self) -> None:
        """Clear conversation history and start fresh"""
        self._initialize_chat()
    
    def get_learning_path(self) -> Optional[str]:
        """
        Generate a complete learning path for Flutter development
        
        Returns:
            Structured learning path
        """
        prompt = """ุฃูุดุฆ ูุณุงุฑ ุชุนูููู ูุงูู ูุชุนูู Dart ู Flutter ูู ุงูุตูุฑ ุญุชู ุงูุงุญุชุฑุงู:

## ๐ ูุณุงุฑ ุชุนูู Dart ู Flutter

### ุงููุฑุญูุฉ 1: ุงูุฃุณุงุณูุงุช (ุฃุณุจูุน 1-2)
- ุงูุฏุฑูุณ ุงููุทููุจุฉ
- ุงูุชูุงุฑูู ุงูุนูููุฉ
- ูุดุฑูุน ุตุบูุฑ ููุชุทุจูู

### ุงููุฑุญูุฉ 2: ุงูุจุฑูุฌุฉ ุงููุงุฆููุฉ (ุฃุณุจูุน 3-4)
[ููุณ ุงูุจููุฉ]

### ุงููุฑุญูุฉ 3: Flutter - ูุงุฌูุงุช ุงููุณุชุฎุฏู (ุฃุณุจูุน 5-7)
[ููุณ ุงูุจููุฉ]

### ุงููุฑุญูุฉ 4: ุงูุชุทุจููุงุช ุงููุชูุฏูุฉ (ุฃุณุจูุน 8-10)
[ููุณ ุงูุจููุฉ]

### ุงููุฑุญูุฉ 5: ุงููุดุฑ ูุงูุงุญุชุฑุงู (ุฃุณุจูุน 11-12)
[ููุณ ุงูุจููุฉ]

---

## ๐ ูุตุงุฏุฑ ุชุนููููุฉ ููุตู ุจูุง
## ๐ก ูุตุงุฆุญ ูููุฌุงุญ
## ๐ฏ ุงููุดุงุฑูุน ุงูุนูููุฉ ุงูููุชุฑุญุฉ

ุงุฌุนู ุงููุณุงุฑ ูุงูุนูุงู ููุงุจู ููุชูููุฐ! ๐"""
        
        return self.ask(prompt, include_context=True)
